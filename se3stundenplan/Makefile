# Detect OS for venv paths and python command
ifeq ($(OS),Windows_NT)
  PYTHON_SYS       := python
  VENV_DIR         := backend\.venv
  VENV_BIN         := $(VENV_DIR)\Scripts
  PYTHON           := $(VENV_BIN)\python.exe
  PIP              := $(VENV_BIN)\pip.exe
else
  PYTHON_SYS       := python3
  VENV_DIR         := backend/.venv
  VENV_BIN         := $(VENV_DIR)/bin
  PYTHON           := $(VENV_BIN)/python
  PIP              := $(VENV_BIN)/pip
endif

.PHONY: install install-backend install-frontend \
        build build-backend build-frontend \
        test test-backend test-frontend \
        lint lint-backend lint-frontend \
        clean

install: install-backend install-frontend
	@echo "\nâœ… All dependencies installed."

install-backend:
	@echo "\nðŸ”§ Setting up Python venv & installing backend depsâ€¦"
	@if [ ! -d "$(VENV_DIR)" ]; then \
	  $(PYTHON_SYS) -m venv "$(VENV_DIR)"; \
	else \
	  echo "    â€¢ venv already exists"; \
	fi
	@"$(PIP)" install --upgrade pip
	@"$(PIP)" install -r backend/requirements.txt

install-frontend:
	@echo "\nðŸ“¦ Installing frontend depsâ€¦"
	npm install
	cd frontend && npm install

build: build-backend build-frontend
	@echo "\nðŸš€ Full build complete."

build-backend:
	@echo "\nðŸ”¨ Flask backend has no build step; ready to run."

build-frontend:
	@echo "\nðŸ”¨ Building Next.js frontendâ€¦"
	cd frontend && npm run build

test: test-backend test-frontend
	@echo "\nâœ… All tests passed."

test-backend:
	@echo "\nðŸ§ª Running backend testsâ€¦"
	@"$(PYTHON)" -m pytest -q

test-frontend:
	@echo "\nðŸ§ª Running frontend testsâ€¦"
	cd frontend && npm test

lint: lint-frontend
	@echo "\nâœ… Linting complete."

lint-frontend:
	@echo "\nðŸ” Linting frontend (ESLint)â€¦"
	cd frontend && npm run lint

clean:
ifeq ($(OS),Windows_NT)
	@echo "\nðŸ§¹ Cleaning on Windowsâ€¦"
	@rmdir /S /Q "$(VENV_DIR)"          >nul 2>&1 || true
	@rmdir /S /Q "backend\__pycache__" >nul 2>&1 || true
	@del    /Q "backend\*.pyc"         >nul 2>&1 || true
	@rmdir /S /Q "frontend\node_modules">nul 2>&1 || true
	@rmdir /S /Q "frontend\.next"      >nul 2>&1 || true
else
	@echo "\nðŸ§¹ Cleaning on UNIXâ€¦"
	@rm -rf "$(VENV_DIR)" backend/__pycache__ backend/*.pyc
	@rm -rf frontend/node_modules frontend/.next
endif
	@echo "\nðŸ§¹ Clean complete."
